<h1 id="api-qps-限流服务" tabindex="-1">API QPS 限流服务 <a class="header-anchor" href="#api-qps-限流服务" aria-label="Permalink to “API QPS 限流服务”">&#8203;</a></h1>
<h1 id="github" tabindex="-1"><a href="https://github.com/ice-a/random_api_words" target="_blank" rel="noreferrer">github</a> <a class="header-anchor" href="#github" aria-label="Permalink to “github”">&#8203;</a></h1>
<p><img src="https://i-blog.csdnimg.cn/direct/1237b5440030407794dd8f449c56e95f.png" alt="在这里插入图片描述" loading="lazy"></p>
<h1 id="api-qps-限流服务-1" tabindex="-1">API QPS 限流服务 <a class="header-anchor" href="#api-qps-限流服务-1" aria-label="Permalink to “API QPS 限流服务”">&#8203;</a></h1>
<p>这是一个基于Go语言开发的API服务，具有IP限流和随机数据获取功能。该服务使用MongoDB存储数据，内存实现IP限流功能。</p>
<h2 id="功能特点" tabindex="-1">功能特点 <a class="header-anchor" href="#功能特点" aria-label="Permalink to “功能特点”">&#8203;</a></h2>
<ul>
<li>IP限流保护：每分钟最多允许200次请求</li>
<li>自动封禁：超出限制的IP将被自动封禁10分钟</li>
<li>随机数据获取：支持从MongoDB随机获取数据</li>
<li>高性能：使用内存实现高效的限流机制</li>
</ul>
<h2 id="环境要求" tabindex="-1">环境要求 <a class="header-anchor" href="#环境要求" aria-label="Permalink to “环境要求”">&#8203;</a></h2>
<ul>
<li>Go 1.16+</li>
<li>MongoDB 4.0+</li>
</ul>
<h2 id="数据初始化" tabindex="-1">数据初始化 <a class="header-anchor" href="#数据初始化" aria-label="Permalink to “数据初始化”">&#8203;</a></h2>
<ol>
<li>在 <code>data/data.json</code> 文件中配置初始数据，格式如下：</li>
</ol>
<div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre><!--::markdown-it-async::myu8q80s22s62yntaftp0w::--><code>[
    {&quot;type&quot;: &quot;kfcv50&quot;, &quot;connect&quot;: &quot;123&quot;}
]</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2">
<li>运行初始化脚本：</li>
</ol>
<div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre><!--::markdown-it-async::zmzjo5hrgtri5g1fes0wd::--><code>cd scripts
go run init_db.go</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>该脚本会读取 data.json 中的数据并插入到 MongoDB 数据库中。</p>
<h2 id="快速开始" tabindex="-1">快速开始 <a class="header-anchor" href="#快速开始" aria-label="Permalink to “快速开始”">&#8203;</a></h2>
<h3 id="_1-克隆项目" tabindex="-1">1. 克隆项目 <a class="header-anchor" href="#_1-克隆项目" aria-label="Permalink to “1. 克隆项目”">&#8203;</a></h3>
<div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre><!--::markdown-it-async::lf5tlv09mmn5gewycf2gpi::--><code>git clone https://github.com/ice-a/random_api_words.git api_qps_go
cd api_qps_go</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-安装依赖" tabindex="-1">2. 安装依赖 <a class="header-anchor" href="#_2-安装依赖" aria-label="Permalink to “2. 安装依赖”">&#8203;</a></h3>
<div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre><!--::markdown-it-async::pvxrg0vz6bstv44dt581rf::--><code>go mod download</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_3-配置服务" tabindex="-1">3. 配置服务 <a class="header-anchor" href="#_3-配置服务" aria-label="Permalink to “3. 配置服务”">&#8203;</a></h3>
<p>配置文件位于 <code>config/config.go</code>，您可以根据需要修改以下配置：</p>
<div class="language-go line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre><!--::markdown-it-async::5v9v2vgh2s6hj1cwn63d9::--><code>// MongoDB配置
MongoURI      = &quot;mongodb://localhost:27017&quot;
MongoDatabase = &quot;coll&quot;
MongoCollection = &quot;data&quot;

// API限流配置
MaxRequestsPerMinute = 200
BanDuration = 10 * 60 // 10分钟，单位：秒</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_4-启动服务" tabindex="-1">4. 启动服务 <a class="header-anchor" href="#_4-启动服务" aria-label="Permalink to “4. 启动服务”">&#8203;</a></h3>
<div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre><!--::markdown-it-async::6m49k5o50fqgf861kwkaqc::--><code>go run main.go</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>服务将在 <code>http://localhost:8080</code> 启动</p>
<h3 id="docker部署" tabindex="-1">Docker部署 <a class="header-anchor" href="#docker部署" aria-label="Permalink to “Docker部署”">&#8203;</a></h3>
<ol>
<li>构建Docker镜像</li>
</ol>
<div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre><!--::markdown-it-async::p2bju0c0ec3d7miteq3mg::--><code>docker build -t api-qps-service .</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="2">
<li>运行容器</li>
</ol>
<div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre><!--::markdown-it-async::11u011uiops3gklaojstq::--><code>docker run -d \
  -p 8080:8080 \
  --name api-qps-service \
  api-qps-service</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="api接口" tabindex="-1">API接口 <a class="header-anchor" href="#api接口" aria-label="Permalink to “API接口”">&#8203;</a></h2>
<h3 id="获取随机数据" tabindex="-1">获取随机数据 <a class="header-anchor" href="#获取随机数据" aria-label="Permalink to “获取随机数据”">&#8203;</a></h3>
<div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre><!--::markdown-it-async::p68dln3g5u8ldg1yus0c7a::--><code>GET /random</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>响应示例：</p>
<div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre><!--::markdown-it-async::55rxyd4z1bc5b9etg5o38::--><code>{
    &quot;type&quot;: &quot;example_type&quot;,
    &quot;connect&quot;: &quot;example_connection&quot;
}</code></pre>
<div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="限流说明" tabindex="-1">限流说明 <a class="header-anchor" href="#限流说明" aria-label="Permalink to “限流说明”">&#8203;</a></h3>
<ul>
<li>每个IP每分钟最多允许200次请求</li>
<li>超出限制的IP将被自动封禁10分钟</li>
<li>被封禁的IP访问会收到429状态码</li>
</ul>
<h2 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to “常见问题”">&#8203;</a></h2>
<ol>
<li>
<p><strong>MongoDB连接失败</strong></p>
<ul>
<li>检查MongoDB服务是否正常运行</li>
<li>验证MongoDB连接URI是否正确</li>
<li>确保MongoDB数据库和集合已创建</li>
</ul>
</li>
<li>
<p><strong>API请求返回429状态码</strong></p>
<ul>
<li>这表示您的IP已超出请求限制或已被封禁</li>
<li>请等待一段时间后再试</li>
</ul>
</li>
</ol>
<h2 id="性能优化建议" tabindex="-1">性能优化建议 <a class="header-anchor" href="#性能优化建议" aria-label="Permalink to “性能优化建议”">&#8203;</a></h2>
<ol>
<li>根据实际需求调整<code>MaxRequestsPerMinute</code>和<code>BanDuration</code>参数</li>
<li>适当配置MongoDB索引以提升查询性能</li>
</ol>
